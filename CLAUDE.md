# LLM OS — Claude Code Project Context

You are working on **LLM OS**, an operating system where every application is generated by AI from natural language prompts. This is not an agent framework or chatbot UI — it is a real OS with sandboxed execution and capability-based security.

## Core Values — READ THESE FIRST

Every line of code you write, every feature you add, every decision you make must align with these values. They are non-negotiable.

**1. Protect the user first.**
Their privacy and their integrity, through all means possible. No telemetry, no data collection, no phoning home without explicit consent. Generated apps run in sandboxes. Capabilities are gated by user approval. When in doubt, deny access.

**2. Empower the user.**
The OS exists to serve the user, not to restrict them. Users should be able to generate and run any software they wish — as long as it is not detrimental to humanity as a whole. Never add artificial limitations. The tools should exist to do things efficiently.

**3. Take a piece, leave a piece.**
This is open source built by a community. Code that is contributed should not damage or disrupt the core idea. If you improve something, contribute it back. If you find a bug, report it.

**4. Nothing is perfect.**
These rules aren't perfect and neither is this code. We can always improve — as long as the core intent isn't violated. Ship working code, iterate, improve.

## Architecture

```
Generated Apps (sandboxed iframes / WASM)
         ↕ postMessage
Shell UI (window manager, prompt bar, capability dialogs)
         ↕ HTTP API
Kernel (LLM gateway, static analyzer, capabilities, storage)
         ↕ fetch
LLM Providers (Ollama local, Claude API, OpenAI API)
```

## Project Structure

```
src/
  server.js              — HTTP server, API endpoints, static file serving
  kernel/
    config.js            — Environment config (.env loader)
    gateway.js           — LLM routing (Ollama for simple, Claude for complex)
    analyzer.js          — Static analysis (regex-based, ~35 rules, blocks eval/injection)
    capabilities.js      — Capability tokens (HMAC-SHA256 signed, constant-time verify)
    storage.js           — Per-app persistent storage (JSON files, 5MB quota)
    scheduler.js         — Background self-improvement task scheduler
    profile.js           — OS profile & ephemeral mode (data/profile.yaml)
    knowledge.js         — Knowledge base / memory
    providers/
      ollama.js          — Local Ollama inference
      claude.js          — Anthropic Claude API
      openai-compatible.js — OpenAI, OpenRouter, Groq, Together, vLLM, LM Studio
    registry/
      store.js           — App registry (SHA-256 content-addressed, trigram search)
    wasm-sandbox/
      index.js           — WASM sandbox controller (launch, kill, host calls)
      worker.js          — WASM worker thread (runs in worker_threads)
    docker/
      client.js          — Docker API client (container lifecycle)
      process-manager.js — Process app management (bots, agents, servers)
    self-improve/
      index.js           — Task registry for automated improvement
      generate-apps.js   — Generates diverse apps from 80+ prompt categories
      test-security.js   — Adversarial security testing
      improve-apps.js    — Rewrites apps with better UX
      qc-apps.js         — Quality checks registry apps
      claude-agent.js    — Claude agent queue & coordination
    utils/
      normalize.js       — Text normalization, similarity, token counting
  sdk/
    sdk.js               — In-sandbox SDK (runs inside iframes, postMessage bridge)
  shell/
    index.html           — Desktop UI (prompt bar, windows, modals, log)
    sandbox.js           — Iframe sandbox manager (creates, injects SDK, kills)
  apps/
    nanoclaw.js          — Container-based agent framework
tests/
  analyzer.test.js       — 46 tests: analyzer rules
  storage.test.js        — 43 tests: CRUD, quota, persistence, isolation
  registry.test.js       — 46 tests: publish, search, browse, tags
  scheduler.test.js      — 46 tests: tasks, circuit breaker, budget
  gateway.test.js        — 38 tests: sanitization, complexity, providers
  wasm-sandbox.test.js   — 27 tests: launch, kill, timeouts, memory, isolation
  capabilities.test.js   — 51 tests: HMAC tokens, expiry, revocation, forgery
  security/              — Injection vectors, analyzer vectors (JSON test data)
```

## How It Works

1. User types a prompt ("make me a calculator")
2. `gateway.js` sanitizes input, routes to best LLM, gets generated HTML/JS
3. `analyzer.js` scans the code for eval(), parent access, fetch(), etc.
4. Shell shows capability approval dialog to the user
5. User approves → `sandbox.js` creates an iframe with `sandbox="allow-scripts"` + strict CSP
6. SDK is injected into the iframe; app communicates with kernel via postMessage
7. Kernel validates every SDK call against the app's approved capabilities

## Key Principles for Code

- **No dependencies unless absolutely necessary.** The prototype has zero npm runtime deps.
- **Vanilla JS/HTML/CSS.** No React, Vue, Angular. Keep it simple and auditable.
- **Every component works standalone.** Mock what you need, test in isolation.
- **Security by default.** Sandboxes deny everything. Capabilities must be explicitly granted.
- **No telemetry, no tracking, no analytics.** User privacy is non-negotiable.
- **Dark color scheme.** Background: #0d0d1a, text: #e0e0f0, accent: #6c63ff.

## When Modifying Code

- Read existing code before changing it. Understand patterns before proposing alternatives.
- The static analyzer (`analyzer.js`) must NEVER use an LLM — it must be deterministic.
- The SDK (`sdk.js`) runs inside untrusted iframes — it must never trust the host directly.
- The gateway (`gateway.js`) must sanitize ALL user input before passing to any LLM.
- Generated apps must never be able to escape their sandbox. If you find an escape vector, fix it immediately and file an issue.

## Before You Submit — Mandatory Verification

IMPORTANT: After making any changes, you MUST run the values check before committing:

```bash
node scripts/values-check.js
```

This scans your changes for:
- Telemetry/analytics/tracking code (violates Value 1)
- Sandbox weakening patterns (violates Value 1)
- Privacy violations like direct cookie/storage access (violates Value 1)
- Artificial feature limitations (violates Value 2)
- Destructive operations on core directories (violates Value 3)
- Credential files or .env files (never commit secrets)

If it reports CRITICAL findings, fix them before committing. No exceptions.

On pull requests, a second layer runs: an AI-powered Values Guardian that reviews the full diff against the core values and posts its findings as a PR comment.

## Running the Prototype

```bash
cp .env.example .env     # Set OLLAMA_URL or ANTHROPIC_API_KEY
node src/server.js       # http://localhost:3000
```

## Open Contribution Areas

See CONTRIBUTING.md for detailed prompts for each component. Priority areas:
- LLM-driven system configuration (natural language → display, browser, boot policies)
- Shell UI improvements (drag-resize windows, minimize/maximize, settings panel)
- Security hardening (sandbox escape audit, prompt injection testing)
- Custom Rust microkernel (long-term, `no_std`, UEFI boot)

Already implemented: WASM sandbox, cryptographic capability tokens, app registry, persistent storage, bootable VM images, LLM gateway with 6+ providers, static analyzer, self-improvement scheduler.
